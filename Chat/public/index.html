<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Web Chat</title>
  <style>
    /* Basic styles */
    #chat-box {
      height: 300px;
      width: 300px;
      border: 1px solid #ccc;
      overflow-y: scroll;
    }
    .message {
      padding: 5px;
      margin: 5px;
      border-bottom: 1px solid #eee;
    }
    .evaluated {
      color: green;
      font-weight: bold;
    }
    .not-evaluated {
      color: red;
      font-style: italic;
    }
    #input-container {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h2>Web Chat</h2>

  <div id="chat-box"></div>

  <div id="input-container">
    <input type="text" id="username-input" placeholder="Enter your username" />
    <button id="set-username-button">Set Username</button>
    <br />
    <input type="text" id="recipient-input" placeholder="Recipient's username" />
    <input type="text" id="message-input" placeholder="Type your message" />
    <button id="send-button">Send</button>
    <button id="logout-button" style="display: none;">Logout</button>
  </div>

  <script>
    const usernameInput = document.getElementById("username-input");
    const setUsernameButton = document.getElementById("set-username-button");
    const recipientInput = document.getElementById("recipient-input");
    const messageInput = document.getElementById("message-input");
    const sendButton = document.getElementById("send-button");
    const chatBox = document.getElementById("chat-box");
    const logoutButton = document.getElementById("logout-button");

    let username = getCookie("username"); // Try to get the username from the cookie
    let ws;

    // Check if there's a username cookie on page load
    if (username) {
      initializeWebSocket(username);
      fetchMessages(); // Fetch all messages for logged-in user
    }

    // Get cookie by name
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return null;
    }

    // Set cookie
    function setCookie(name, value, days) {
      const d = new Date();
      d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
      const expires = "expires=" + d.toUTCString();
      document.cookie = name + "=" + value + ";" + expires + ";path=/";
    }

    // Logout function
    function logout() {
      // Delete the username cookie
      document.cookie = "username=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/";
      if (ws) {
        ws.close();
      }
      username = null;
      document.getElementById("username-input").style.display = "block";
      document.getElementById("set-username-button").style.display = "block";
      document.getElementById("recipient-input").style.display = "none";
      document.getElementById("message-input").style.display = "none";
      document.getElementById("send-button").style.display = "none";
      logoutButton.style.display = "none";
      chatBox.innerHTML = ''; // Clear chat on logout
    }

    // Initialize WebSocket connection with a username
    function initializeWebSocket(username) {
      ws = new WebSocket("ws://localhost:3000");

      ws.onopen = () => {
        // Send the username once connected
        ws.send(username);
        document.getElementById("username-input").style.display = "none";
        document.getElementById("set-username-button").style.display = "none";
        document.getElementById("recipient-input").style.display = "block";
        document.getElementById("message-input").style.display = "block";
        document.getElementById("send-button").style.display = "block";
        logoutButton.style.display = "block";
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data); // Parse the JSON data received from the server

        // Create a new message element
        const messageElement = document.createElement("div");
        messageElement.classList.add("message");

        // Check if the message is evaluated
        if (data.evaluated) {
          // If evaluated, show the toxicity level
          messageElement.innerHTML = `${data.sender}: ${data.message} <span class="evaluated">(Toxicity: ${data.toxicity})</span>`;
        } else {
          // If not evaluated, show the status as "Not Evaluated"
          messageElement.innerHTML = `${data.sender}: ${data.message} <span class="not-evaluated">(Not Evaluated)</span>`;
        }

        // Append the message to the chat box
        chatBox.appendChild(messageElement);

        // Scroll to the bottom of the chat box to show the new message
        chatBox.scrollTop = chatBox.scrollHeight;
      };
    }

    // Handle sending messages
    sendButton.onclick = () => {
      if (ws && recipientInput.value.trim() && messageInput.value.trim()) {
        const message = `${recipientInput.value.trim()}:${messageInput.value.trim()}`;
        ws.send(message);
        messageInput.value = ''; // Clear message input
      }
    };

    // Handle setting username
    setUsernameButton.onclick = () => {
      if (usernameInput.value.trim()) {
        username = usernameInput.value.trim();
        setCookie("username", username, 7); // Store username in cookies for 7 days
        initializeWebSocket(username);
      }
    };

    // Handle logout
    logoutButton.onclick = logout;

    // Fetch all messages for the logged-in user
    async function fetchMessages() {
      try {
        const response = await fetch(`/messages/${username}`);
        const messages = await response.json();
        
        // Clear the chat box before updating
        chatBox.innerHTML = '';

        // Display all messages
        messages.forEach((message) => {
          const messageElement = document.createElement("div");
          messageElement.classList.add("message");

          if (message.evaluated) {
            messageElement.innerHTML = `${message.sender}: ${message.message} <span class="evaluated">(Toxicity: ${message.toxicity})</span>`;
          } else {
            messageElement.innerHTML = `${message.sender}: ${message.message} <span class="not-evaluated">(Not Evaluated)</span>`;
          }

          chatBox.appendChild(messageElement);
        });
        chatBox.scrollTop = chatBox.scrollHeight;
      } catch (error) {
        console.error("Error fetching messages:", error);
      }
    }

    // Refresh the chat every 1 second
    setInterval(fetchMessages, 1000); // Refresh every 1000 milliseconds (1 second)
  </script>
</body>
</html>
